<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>YouTube Playlist Downloader</title>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #e3f2fd, #ffffff);
        padding: 40px;
        max-width: 900px;
        margin: auto;
        color: #333;
      }
      .input-box {
        display: flex;
        justify-content: center;
        align-items: center;
        background: #ffffff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.06);
        margin: auto;
        max-width: 800px;
        gap: 10px;
        flex-wrap: wrap;
      }

      .input-box input[type="text"] {
        flex: 1 1 300px;
        min-width: 200px;
      }

      .input-box button {
        flex: 0 0 auto;
      }

      h2 {
        text-align: center;
        color: #0d47a1;
        margin-bottom: 30px;
      }

      input[type="text"] {
        width: 70%;
        padding: 12px 15px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 16px;
        transition: 0.3s ease;
      }

      input[type="text"]:focus {
        outline: none;
        border-color: #1976d2;
        box-shadow: 0 0 8px rgba(25, 118, 210, 0.2);
      }

      button {
        padding: 12px 20px;
        font-size: 16px;
        margin: 10px 5px;
        border: none;
        border-radius: 6px;
        background-color: #1976d2;
        color: white;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      button:hover {
        background-color: #1565c0;
      }

      #videos {
        margin-top: 30px;
      }

      .video {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        padding: 15px;
        margin-top: 15px;
        border-left: 6px solid #2196f3;
        diplay: flex;
      }

      .video strong {
        font-size: 17px;
        color: #0d47a1;
      }

      .bar {
        height: 20px;
        background: #eee;
        border-radius: 6px;
        overflow: hidden;
        margin-top: 10px;
      }

      .fill {
        height: 100%;
        background: #1565c0;
        width: 0%;
        color: white;
        text-align: center;
        line-height: 20px;
        font-size: 13px;
        transition: width 0.3s ease-in-out;
      }

      .done {
        background-color: #2196f3 !important;
      }

      .error {
        background-color: #e53935 !important;
      }

      @media (max-width: 600px) {
        input[type="text"] {
          width: 100%;
          margin-bottom: 10px;
        }

        button {
          width: 48%;
          font-size: 14px;
        }
      }
    </style>
  </head>
  <body>
    <h2>YouTube Playlist Downloader</h2>

    <div class="input-box">
      <input type="text" id="url" placeholder="Enter playlist URL" />
      <button onclick="fetchVideos()">Fetch</button>
      <button onclick="startDownload()">Download</button>
    </div>

    <div id="videos"></div>

    <script>
      const socket = io();
      let fetchedVideos = [];

      socket.on("connect", () => {
        console.log("Connected to server via Socket.IO");
      });

      socket.on("progress", (data) => {
        const el = document.getElementById("bar-" + data.id);
        if (el) {
          el.style.width = data.pct + "%";
          el.innerText = data.pct + "%";
        }
      });

      socket.on("done", (data) => {
        const el = document.getElementById("bar-" + data.id);
        if (el) {
          el.classList.add("done");
          el.style.width = "100%";
          el.innerText = "Completed";
        }
      });

      socket.on("error", (data) => {
        const el = document.getElementById("bar-" + data.id);
        if (el) {
          el.classList.add("error");
          el.style.width = "100%";
          el.innerText = "Error";
        }
      });

      function fetchVideos() {
        const url = document.getElementById("url").value;
        if (!url.trim()) return alert("Please enter a playlist URL");

        fetch("/fetch", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.error) return alert(data.error);
            fetchedVideos = data.videos;
            renderVideos(fetchedVideos);
          })
          .catch((err) => console.error(err));
      }

      function renderVideos(videos) {
        const container = document.getElementById("videos");
        container.innerHTML = "";
        videos.forEach((video, index) => {
          const div = document.createElement("div");
          div.className = "video";
          div.innerHTML = `
            <div><strong>${video.index}. ${video.title}</strong></div>
           
            <button onclick="downloadSingle(${index})">Download</button>
            <div class="bar"><div class="fill" id="bar-${video.id}">0%</div></div>
          `;
          container.appendChild(div);
        });
      }

      function startDownload() {
        if (fetchedVideos.length === 0) return alert("Fetch videos first!");

        fetch("/download", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ videos: fetchedVideos }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.error) alert(data.error);
          })
          .catch((err) => console.error(err));
      }

      function downloadSingle(index) {
        const video = fetchedVideos[index];
        fetch("/download", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ videos: [video] }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.error) alert(data.error);
          })
          .catch((err) => console.error(err));
      }
    </script>
  </body>
</html>
